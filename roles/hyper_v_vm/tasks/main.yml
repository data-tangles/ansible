- name: Check if VHDX is already present
  win_stat:
    path: "{{ TEMPLATE_VHDX_DESTINATION_DIR }}{{ VM_NAME }}.vhdx"
    get_checksum: false
  register: vhdx_exists

- name: Clone Template VHDX
  win_copy:
    src: "{{ TEMPLATE_VHDX_SOURCE }}"
    dest: "{{ TEMPLATE_VHDX_DESTINATION_DIR }}{{ VM_NAME }}.vhdx"
    force: false
    remote_src: true
  when: vhdx_exists.stat.exists == false

- name: Create VMs
  win_hyperv_guest:
    name: "{{ VM_NAME }}"
    generation: "{{ VM_GENERATION}}"
    cpu: "{{ VM_CPU }}"
    memory: "{{ VM_MEMORY }}"
    network_switch: "{{ VM_SWITCH }}"
    diskpath: "{{ TEMPLATE_VHDX_DESTINATION_DIR }}{{ VM_NAME }}.vhdx"
    state: present

- name: Power On VM
  win_hyperv_guest:
    name: "{{ VM_NAME }}"
    state: started 
  
- name: Wait for VM to be running
  local_action:
    module: wait_for
    host: "{{ TEMPLATE_IP }}"
    port: "{{ ANSIBLE_PORT }}"
    delay: 360
    state: started
  register: wait_result
