- name: Ensure Image directory exists
  ansible.builtin.file: 
    path: "/docker/images/gh_actions_runner"
    state: directory

- name: Copy Dockerfile
  ansible.builtin.template: 
    src: gha_runner.dockerfile.j2
    dest: /docker/images/gh_actions_runner/gha_runner.dockerfile
    owner: root
    group: root
    mode: 0644

- name: Copy start.sh
  ansible.builtin.template: 
    src: start.sh.j2
    dest: /docker/images/gh_actions_runner/start.sh
    owner: root
    group: root
    mode: 0644

- name: Build GitHub Actions Runner Container
  community.docker.docker_image:
    name: gha-runner:linux
    build:
      path: /docker/images/gh_actions_runner
      dockerfile: gha_runner.dockerfile
    source: build

- name: Deploy GitHub Actions Runner Container
  community.docker.docker_container:
    name: "gha-runner"
    image: "gha-runner:linux"
    restart_policy: always
    networks:
      - name: "proxy"
    env:
      ORGANIZATION: "{{ GH_ORG_URL }}"
      ACCESS_TOKEN: "{{ GH_ORG_TOKEN }}"