- name: deploy Komodo Container Network 
  docker_network:
    name: "komodo"

- name: Create Komodo DB Data Volume
  community.docker.docker_volume:
    name: komodo-db-data
  when: inventory_hostname in groups ["pi"]

- name: Create Komodo DB Config Volume
  community.docker.docker_volume:
    name: komodo-db-config
  when: inventory_hostname in groups ["pi"]

- name: deploy Komodo DB Container
  docker_container:
    name: "komodo-db"
    image: "mongo"
    restart_policy: always
    networks:
      - name: "komodo"
    command: "--quiet --wiredTigerCacheSizeGB 0.25"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "komodo-db-data:/data/db"
      - "komodo-db-config:/data/configdb"
    env:
      MONGO_INITDB_ROOT_USERNAME: "{{ KOMODO_DB_USERNAME }}"
      MONGO_INITDB_ROOT_PASSWORD: "{{ KOMODO_DB_PASSWORD }}"      
    labels:
      komodo.skip:
  when: inventory_hostname in groups ["pi"]

- name: Create Komodo Core Data Volume
  community.docker.docker_volume:
    name: komodo-core-data
  when: inventory_hostname in groups ["pi"]

- name: deploy Komodo Core Container
  docker_container:
    name: "komodo-core"
    image: "ghcr.io/moghtech/komodo-core:1.19.5"
    restart_policy: always
    networks:
      - name: "komodo"
      - name: "proxy"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "komodo-core-data:/backups"
    env:
      KOMODO_DATABASE_ADDRESS: komodo-db:27017
      KOMODO_FIRST_SERVER: https://komodo-periphery:8120
      KOMODO_DATABASE_USERNAME: "{{ KOMODO_DB_USERNAME }}"
      KOMODO_DATABASE_PASSWORD: "{{ KOMODO_DB_PASSWORD }}" 
      KOMODO_PASSKEY: "{{ KOMODO_PASSKEY }}"    
      KOMODO_HOST: "{{ KOMODO_HOST }}"
      KOMODO_LOCAL_AUTH: "true"
      KOMODO_INIT_ADMIN_USERNAME: "{{ KOMODO_INIT_ADMIN_USERNAME }}"
      KOMODO_INIT_ADMIN_PASSWORD: "{{ KOMODO_INIT_ADMIN_PASSWORD }}"
      KOMODO_FIRST_SERVER_NAME: "{{ inventory_hostname_short }}"
    labels:
      komodo.skip:  
      traefik.enable: "true"
      traefik.http.routers.komodo.entrypoints: "http"
      traefik.http.routers.komodo.rule: "Host(`{{ komodo_url }}`)"
      traefik.http.middlewares.komodo-https-redirect.redirectscheme.scheme: "https"
      traefik.http.routers.komodo.middlewares: "komodo-https-redirect"
      traefik.http.routers.komodo-secure.entrypoints: "https"
      traefik.http.routers.komodo-secure.rule: "Host(`{{ komodo_url }}`)"
      traefik.http.routers.komodo-secure.tls: "true"
      traefik.http.routers.komodo-secure.service: "komodo"
      traefik.http.services.komodo.loadbalancer.server.port: "9120"
      traefik.docker.network: "proxy"  
  when: inventory_hostname in groups ["pi"]   

- name: deploy Komodo Periphery Container
  docker_container:
    name: "komodo-periphery"
    image: "ghcr.io/moghtech/komodo-periphery:1.19.5"
    restart_policy: always
    networks:
      - name: "komodo"
    ports: "{{ ['8120:8120'] if 'pi' not in groups else omit }}"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/proc:/proc"
    env:
      KOMODO_PASSKEY: "{{ KOMODO_PASSKEY }}" 
    labels:
      komodo.skip: 
  
