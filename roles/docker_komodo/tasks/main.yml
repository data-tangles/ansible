- name: deploy Komodo Container Network 
  docker_network:
    name: "komodo"

- name: Create Komodo DB Postgres Data Volume
  community.docker.docker_volume:
    name: komodo-db-postgres-data
  when: inventory_hostname in groups ["pi"]

- name: deploy Komodo DB Postgres Container
  docker_container:
    name: "komodo-db-postgres"
    image: "ghcr.io/ferretdb/postgres-documentdb:17-0.107.0-ferretdb-2.7.0"
    restart_policy: always
    networks:
      - name: "komodo"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "komodo-db-postgres-data:/var/lib/postgresql/data"
    env:  
      POSTGRES_USER: "{{ KOMODO_DB_USERNAME }}"
      POSTGRES_PASSWORD: "{{ KOMODO_DB_PASSWORD }}"
      POSTGRES_DB: postgres     
    labels:
      komodo.skip:
  when: inventory_hostname in groups ["pi"]

- name: Create Komodo DB FerretDB Data Volume
  community.docker.docker_volume:
    name: komodo-db-ferretdb-data
  when: inventory_hostname in groups ["pi"]

- name: deploy Komodo DB FerretDB Container
  docker_container:
    name: "komodo-db-ferretdb"
    image: "ghcr.io/ferretdb/ferretdb:2.7.0"
    restart_policy: always
    networks:
      - name: "komodo"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "komodo-db-ferretdb-data:/state"
    env:  
      FERRETDB_POSTGRESQL_URL: postgres://{{ KOMODO_DB_USERNAME }}:{{ KOMODO_DB_PASSWORD }}@komodo-db-postgres:5432/postgres    
    labels:
      komodo.skip:
  when: inventory_hostname in groups ["pi"]

- name: Create Komodo Core Data Volume
  community.docker.docker_volume:
    name: komodo-core-data
  when: inventory_hostname in groups ["pi"]

- name: deploy Komodo Core Container
  docker_container:
    name: "komodo-core"
    image: "ghcr.io/moghtech/komodo-core:1.19.5"
    restart_policy: always
    networks:
      - name: "komodo"
      - name: "proxy"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "komodo-core-data:/backups"
    env:
      KOMODO_DATABASE_ADDRESS: komodo-db-ferretdb:27017
      KOMODO_FIRST_SERVER: https://komodo-periphery:8120
      KOMODO_DATABASE_USERNAME: "{{ KOMODO_DB_USERNAME }}"
      KOMODO_DATABASE_PASSWORD: "{{ KOMODO_DB_PASSWORD }}" 
      KOMODO_PASSKEY: "{{ KOMODO_PASSKEY }}"    
      KOMODO_HOST: "{{ KOMODO_HOST }}"
      KOMODO_LOCAL_AUTH: "true"
      KOMODO_INIT_ADMIN_USERNAME: "{{ KOMODO_INIT_ADMIN_USERNAME }}"
      KOMODO_INIT_ADMIN_PASSWORD: "{{ KOMODO_INIT_ADMIN_PASSWORD }}"
      KOMODO_FIRST_SERVER_NAME: "{{ inventory_hostname_short }}"
    labels:
      komodo.skip:  
      traefik.enable: "true"
      traefik.http.routers.komodo.entrypoints: "websecure"
      traefik.http.routers.komodo.rule: "Host(`{{ komodo_url }}`)"
      traefik.http.routers.komodo.tls: "true"
      traefik.http.routers.komodo.service: "komodo"
      traefik.http.services.komodo.loadbalancer.server.port: "9120"
      traefik.docker.network: "proxy"  
  when: inventory_hostname in groups ["pi"]   

- name: deploy Komodo Periphery Container
  docker_container:
    name: "komodo-periphery"
    image: "ghcr.io/moghtech/komodo-periphery:1.19.5"
    restart_policy: always
    networks:
      - name: "komodo"
    ports: "{{ ['8120:8120'] if 'pi' not in groups else omit }}"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/proc:/proc"
    env:
      KOMODO_PASSKEY: "{{ KOMODO_PASSKEY }}" 
    labels:
      komodo.skip: 
  
